___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "VI",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAkACQAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAQABADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9GP8AgpZ8VtF+G37SHhqH4q6b4yX4U6t4dkt9E1bRtUa2tbfxEJZmMNyqsu1niFv5MjkIHLhgy7ins/7J3xp1rQLHwf8ADP4iW+sQePJPDi6ml9dlZYdUVWIeMSgktPEhTeDknlsnqfmj9tOfwP4G/wCCgPi7Vv2i/CvijxL8N/EHgi30bwRPa6VdalplvIxf7fasluCUvZZPKeOQgFQoO5cKQ7/glf4H+Mn/AAuDw9P8TvBnjyHwToWgag3w61DXry3e90SxluVRLTUkG2T7WbcRheM7OCvyZT6iVOEsAo1Nkrp93Z25dd76TXz3SPgYzqwzd1KG8pcrVr2jeKbnpomlek76bbN2/9k\u003d"
  },
  "categories" : ["MARKETING", "ANALYTICS"]
  "description": "Visitor Intelligence",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "API Key",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "gaUID",
    "displayName": "Google Analytics Property ID",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "valueHint": "UA-163165954-1"
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "customDimensions",
    "displayName": "",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Custom Dimension",
        "name": "custDim",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "cd1",
            "displayValue": "cd1"
          },
          {
            "value": "cd2",
            "displayValue": "cd2"
          },
          {
            "value": "cd3",
            "displayValue": "cd3"
          },
          {
            "value": "cd4",
            "displayValue": "cd4"
          },
          {
            "value": "cd5",
            "displayValue": "cd5"
          },
          {
            "value": "cd6",
            "displayValue": "cd6"
          },
          {
            "value": "cd7",
            "displayValue": "cd7"
          },
          {
            "value": "cd8",
            "displayValue": "cd8"
          },
          {
            "value": "cd9",
            "displayValue": "cd9"
          },
          {
            "value": "cd10",
            "displayValue": "cd10"
          },
          {
            "value": "cd11",
            "displayValue": "cd11"
          },
          {
            "value": "cd12",
            "displayValue": "cd12"
          },
          {
            "value": "cd13",
            "displayValue": "cd13"
          },
          {
            "value": "cd14",
            "displayValue": "cd14"
          },
          {
            "value": "cd15",
            "displayValue": "cd15"
          },
          {
            "value": "cd16",
            "displayValue": "cd16"
          },
          {
            "value": "cd17",
            "displayValue": "cd17"
          },
          {
            "value": "cd18",
            "displayValue": "cd18"
          },
          {
            "value": "cd19",
            "displayValue": "cd19"
          },
          {
            "value": "cd20",
            "displayValue": "cd20"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "VI Value",
        "name": "viValue",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "status",
            "displayValue": "status"
          },
          {
            "value": "message",
            "displayValue": "message"
          },
          {
            "value": "duns",
            "displayValue": "duns"
          },
          {
            "value": "parentDuns",
            "displayValue": "parentDuns"
          },
          {
            "value": "domesticUltimateDuns",
            "displayValue": "domesticUltimateDuns"
          },
          {
            "value": "ultimateDuns",
            "displayValue": "ultimateDuns"
          },
          {
            "value": "companyName",
            "displayValue": "companyName"
          },
          {
            "value": "companyAddress",
            "displayValue": "companyAddress"
          },
          {
            "value": "companyCity",
            "displayValue": "companyCity"
          },
          {
            "value": "companyState",
            "displayValue": "companyState"
          },
          {
            "value": "companyZip5",
            "displayValue": "companyZip5"
          },
          {
            "value": "companyZip4",
            "displayValue": "companyZip4"
          },
          {
            "value": "companyCounty",
            "displayValue": "companyCounty"
          },
          {
            "value": "companyMsa",
            "displayValue": "companyMsa"
          },
          {
            "value": "companyRegion",
            "displayValue": "companyRegion"
          },
          {
            "value": "companyCountry",
            "displayValue": "companyCountry"
          },
          {
            "value": "fortune1000",
            "displayValue": "fortune1000"
          },
          {
            "value": "industryNaics",
            "displayValue": "industryNaics"
          },
          {
            "value": "naicsCodes",
            "displayValue": "naicsCodes"
          },
          {
            "value": "industrySic",
            "displayValue": "industrySic"
          },
          {
            "value": "sicCodes",
            "displayValue": "sicCodes"
          },
          {
            "value": "salesAnnual",
            "displayValue": "salesAnnual"
          },
          {
            "value": "salesAnnualNum",
            "displayValue": "salesAnnualNum"
          },
          {
            "value": "employeesAtLocation",
            "displayValue": "employeesAtLocation"
          },
          {
            "value": "employeesAtLocationNum",
            "displayValue": "employeesAtLocationNum"
          },
          {
            "value": "employeesInAllLocations",
            "displayValue": "employeesInAllLocations"
          },
          {
            "value": "employeesInAllLocationsNum",
            "displayValue": "employeesInAllLocationsNum"
          },
          {
            "value": "familyTreeSize",
            "displayValue": "familyTreeSize"
          },
          {
            "value": "familyTreeSizeNum",
            "displayValue": "familyTreeSizeNum"
          },
          {
            "value": "networth",
            "displayValue": "networth"
          },
          {
            "value": "networthNum",
            "displayValue": "networthNum"
          },
          {
            "value": "walletSize",
            "displayValue": "walletSize"
          },
          {
            "value": "cardOfferResponsiveness",
            "displayValue": "cardOfferResponsiveness"
          },
          {
            "value": "propensityForLoan",
            "displayValue": "propensityForLoan"
          },
          {
            "value": "propensityForLease",
            "displayValue": "propensityForLease"
          },
          {
            "value": "propensityForLoc",
            "displayValue": "propensityForLoc"
          },
          {
            "value": "itExpense",
            "displayValue": "itExpense"
          },
          {
            "value": "telecomSpend",
            "displayValue": "telecomSpend"
          },
          {
            "value": "techOfficeDemand",
            "displayValue": "techOfficeDemand"
          },
          {
            "value": "delinquencyRate",
            "displayValue": "delinquencyRate"
          },
          {
            "value": "howTheyPay",
            "displayValue": "howTheyPay"
          },
          {
            "value": "marketability",
            "displayValue": "marketability"
          },
          {
            "value": "tradeStyle",
            "displayValue": "tradeStyle"
          },
          {
            "value": "companyTelephone",
            "displayValue": "companyTelephone"
          },
          {
            "value": "domain",
            "displayValue": "domain"
          },
          {
            "value": "parentName",
            "displayValue": "parentName"
          },
          {
            "value": "domesticUltimateName",
            "displayValue": "domesticUltimateName"
          },
          {
            "value": "ultimateName",
            "displayValue": "ultimateName"
          },
          {
            "value": "ticker",
            "displayValue": "ticker"
          },
          {
            "value": "exchange",
            "displayValue": "exchange"
          },
          {
            "value": "ein",
            "displayValue": "ein"
          },
          {
            "value": "id",
            "displayValue": "id"
          },
          {
            "value": "ipCountry",
            "displayValue": "ipCountry"
          }
        ],
        "macrosInSelect": true
      }
    ],
    "enablingConditions": [
      {
        "paramName": "gaUID",
        "paramValue": "",
        "type": "NOT_EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
const injectScript = require('injectScript');
const Math = require('Math');
const setInWindow = require('setInWindow');
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');
const getCookieValues = require('getCookieValues');
const sendPixel = require('sendPixel');

//log('data =', data);
const inputData = data;

const apiKey = data.apiKey;
const coreTag = "https://cdn-0.d41.co/tags/dnb_coretag_v5.min.js";
const viScript =  "https://" + apiKey + ".d41.co/sync/";
let uaID = data.gaUID;
var cid = getCookieValues('_ga');
var cidFormatted = '';

//log(cid);
if (cid.length == 0){

}
else {
  cid = getCookieValues('_ga');
  cidFormatted = cid[0].split('.')[2] + '.' +  cid[0].split('.')[3];
}


if (uaID.indexOf('UA') == -1){
    uaID = 'UA-' + uaID;
    }

//log(cidFormatted);

function onCoreSuccess(){
  //log('core success');
  injectScript(viScript, onVISuccess, onVIFailure);
}

function onCoreFailure(){
	log(' https://cdn-0.d41.co/tags/dnb_coretag_v5.min.js failed to load');
}

function onVISuccess(){
  //log('vi success');
  var dnbvid = copyFromWindow('dnbvid');
  callInWindow('dnbvid.getData', apiKey, "json", "T", "{}", function(dnb_data){
  	//log('VI success');
   // log(dnb_data);
    var dataLayerPush = {"event" : "DnB VI", "DnB-Data" : dnb_data};
    pushtoDataLayer(dataLayerPush);
    if (data.customDimensions){
     gaBuildData(dnb_data); 
    }
  });
}

function onVIFailure(){
  log('Failed to load', viScript);
}

function pushtoDataLayer(dnbData){
 // log("pushing to data layer");
  callInWindow("dataLayer.push", dnbData);
}

function gaBuildData(dnb_data){
  //log('building ga data');
  //log('inputData =', data);
  var custDimensions = '';
  for (var i=0; i<data.customDimensions.length;i++){
    if (i==0){
    custDimensions = data.customDimensions[i].custDim + "=" + dnb_data[data.customDimensions[i].viValue];
    }
    else{
      custDimensions = custDimensions + '&' + data.customDimensions[i].custDim + "=" + dnb_data[data.customDimensions[i].viValue];
    }
  }
  //log('custDimension string', custDimensions);
  sendDatatoGA(custDimensions);
}

function sendDatatoGA(custDimensions){
  //log('sending to ga');
  var gaHitURL = 'https://www.google-analytics.com/collect?v=1&t=event&tid=' + uaID + '&cid=' + cidFormatted + '&ec=VI_Complete&ni=1&' + custDimensions;
  sendPixel(gaHitURL);
}

injectScript(coreTag, onCoreSuccess, onCoreFailure);
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn-0.d41.co/tags/dnb_coretag_v4.min.js"
              },
              {
                "type": 1,
                "string": "https://*.d41.co/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dnbvid.getData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dnbvid"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_ga"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.google-analytics.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: testing
  code: |-
    const mockData = {
      // Mocked field values
      apiKey: 23838
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 6/19/2020, 11:26:06 AM


